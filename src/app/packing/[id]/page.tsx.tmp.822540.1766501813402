import { createAdminClient } from '@/lib/supabase/admin'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { notFound } from 'next/navigation'

interface PageProps {
  params: Promise<{ id: string }>
}

interface PackingItem {
  id: string
  packing_list_id: string
  product_code: string
  product_name?: string
  qty: number
  cartons: number
  nw_kg?: number
  gw_kg?: number
  cbm?: number
  pallets?: number
  pallet_number?: number
  created_at?: string
}

async function getPackingList(plNumber: string) {
  const supabase = createAdminClient()

  // 패킹리스트 조회
  const { data: packingList, error } = await supabase
    .from('ru_packing_lists')
    .select('*')
    .eq('pl_number', plNumber)
    .single()

  if (error || !packingList) {
    return null
  }

  // 패킹 품목 조회
  const { data: items } = await supabase
    .from('ru_packing_items')
    .select('*')
    .eq('packing_list_id', plNumber)
    .order('pallet_number', { ascending: true })

  // 발주 정보 조회
  const { data: order } = await supabase
    .from('ru_orders')
    .select('order_number, buyer_name, destination, status')
    .eq('id', packingList.order_id)
    .single()

  return {
    ...packingList,
    items: items || [],
    order: order || undefined
  }
}

export default async function PackingListDetailPage({ params }: PageProps) {
  const { id } = await params
  const packingList = await getPackingList(decodeURIComponent(id))

  if (!packingList) {
    notFound()
  }

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('ko-KR').format(price)
  }

  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-'
    return new Date(dateString).toLocaleDateString('ko-KR')
  }

  // 팔레트별 그룹화
  const palletGroups = new Map<number, typeof packingList.items>()
  packingList.items.forEach(item => {
    const palletNo = item.pallet_number || 0
    const existing = palletGroups.get(palletNo) || []
    palletGroups.set(palletNo, [...existing, item])
  })

  return (
    <div className="container mx-auto py-8 px-4">
      {/* 헤더 */}
      <div className="flex justify-between items-start mb-6">
        <div>
          <h1 className="text-3xl font-bold font-mono">{packingList.pl_number}</h1>
          <p className="text-muted-foreground mt-1">
            패킹리스트 상세 · 발주: {packingList.order?.order_number}
          </p>
        </div>
        <div className="flex gap-2">
          <Link href="/packing">
            <Button variant="outline">← 목록으로</Button>
          </Link>
          <Link href={`/orders/${packingList.order_id}`}>
            <Button variant="outline">발주 보기</Button>
          </Link>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* 기본 정보 */}
        <div className="lg:col-span-2 space-y-6">
          {/* 수출/수입자 정보 */}
          <Card>
            <CardHeader>
              <CardTitle>기본 정보</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 gap-6">
                {/* Exporter */}
                <div className="space-y-2">
                  <h4 className="font-medium text-sm text-muted-foreground">Exporter</h4>
                  <div className="text-sm">
                    <p className="font-medium">{packingList.exporter_name || '-'}</p>
                    <p className="text-muted-foreground">{packingList.exporter_address || '-'}</p>
                    <p>Tel: {packingList.exporter_tel || '-'}</p>
                    <p>Fax: {packingList.exporter_fax || '-'}</p>
                  </div>
                </div>

                {/* Consignee */}
                <div className="space-y-2">
                  <h4 className="font-medium text-sm text-muted-foreground">Consignee</h4>
                  <div className="text-sm">
                    <p className="font-medium">{packingList.consignee_name || packingList.order?.buyer_name || '-'}</p>
                    <p className="text-muted-foreground">{packingList.consignee_address || '-'}</p>
                    <p>Tel: {packingList.consignee_tel || '-'}</p>
                    <p>Email: {packingList.consignee_email || '-'}</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* 선적 정보 */}
          <Card>
            <CardHeader>
              <CardTitle>선적 정보</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <p className="text-muted-foreground">선적항</p>
                  <p className="font-medium">{packingList.shipping_port || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">목적지</p>
                  <p className="font-medium">{packingList.destination || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">출발일</p>
                  <p className="font-medium">{formatDate(packingList.departure_date)}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">선박/항공</p>
                  <p className="font-medium">{packingList.vessel_flight || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">HS Code</p>
                  <p className="font-mono">{packingList.hs_code || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">결제조건</p>
                  <p className="font-medium">{packingList.payment_term || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">인보이스번호</p>
                  <p className="font-mono">{packingList.invoice_number || '-'}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">인보이스일자</p>
                  <p className="font-medium">{formatDate(packingList.invoice_date)}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* 패킹 품목 */}
          <Card>
            <CardHeader>
              <CardTitle>패킹 품목</CardTitle>
              <CardDescription>
                총 {packingList.items.length}개 품목 · {packingList.total_cartons} CTN
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>팔레트</TableHead>
                    <TableHead>품목코드</TableHead>
                    <TableHead>품목명</TableHead>
                    <TableHead className="text-right">수량</TableHead>
                    <TableHead className="text-right">박스</TableHead>
                    <TableHead className="text-right">N/W(kg)</TableHead>
                    <TableHead className="text-right">G/W(kg)</TableHead>
                    <TableHead className="text-right">CBM</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {packingList.items.map((item, index) => (
                    <TableRow key={item.id || index}>
                      <TableCell>
                        {item.pallet_number ? `P${item.pallet_number}` : '-'}
                      </TableCell>
                      <TableCell className="font-mono">{item.product_code}</TableCell>
                      <TableCell className="max-w-[200px] truncate">
                        {item.product_name || '-'}
                      </TableCell>
                      <TableCell className="text-right">{item.qty.toLocaleString()}</TableCell>
                      <TableCell className="text-right">{item.cartons}</TableCell>
                      <TableCell className="text-right">{item.nw_kg?.toFixed(2) || '-'}</TableCell>
                      <TableCell className="text-right">{item.gw_kg?.toFixed(2) || '-'}</TableCell>
                      <TableCell className="text-right">{item.cbm?.toFixed(4) || '-'}</TableCell>
                    </TableRow>
                  ))}
                  {/* 합계 */}
                  <TableRow className="bg-muted/50 font-medium">
                    <TableCell colSpan={3}>합계</TableCell>
                    <TableCell className="text-right">
                      {packingList.total_qty.toLocaleString()}
                    </TableCell>
                    <TableCell className="text-right">
                      {packingList.total_cartons}
                    </TableCell>
                    <TableCell className="text-right">
                      {packingList.total_nw_kg?.toFixed(2) || '-'}
                    </TableCell>
                    <TableCell className="text-right">
                      {packingList.total_gw_kg?.toFixed(2) || '-'}
                    </TableCell>
                    <TableCell className="text-right">
                      {packingList.total_cbm?.toFixed(4) || '-'}
                    </TableCell>
                  </TableRow>
                </TableBody>
              </Table>
            </CardContent>
          </Card>
        </div>

        {/* 사이드바 - 요약 */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>패킹 요약</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">총 수량</span>
                <span className="font-bold">{packingList.total_qty.toLocaleString()} EA</span>
              </div>
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">총 박스</span>
                <span className="font-bold">{packingList.total_cartons} CTN</span>
              </div>
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">총 팔레트</span>
                <span className="font-bold">{packingList.total_pallets} PLT</span>
              </div>
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">순중량 (N/W)</span>
                <span className="font-bold">{packingList.total_nw_kg?.toFixed(2) || 0} kg</span>
              </div>
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">총중량 (G/W)</span>
                <span className="font-bold">{packingList.total_gw_kg?.toFixed(2) || 0} kg</span>
              </div>
              <div className="flex justify-between py-2 border-b">
                <span className="text-muted-foreground">체적 (CBM)</span>
                <span className="font-bold">{packingList.total_cbm?.toFixed(4) || 0}</span>
              </div>
              <div className="flex justify-between py-2 pt-2 border-t-2">
                <span className="font-medium">총 금액</span>
                <span className="font-bold text-lg">
                  ₩{formatPrice(packingList.total_amount || 0)}
                </span>
              </div>
            </CardContent>
          </Card>

          {/* 날짜 정보 */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm">일자 정보</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">생성일</span>
                <span>{formatDate(packingList.created_date)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">인보이스일</span>
                <span>{formatDate(packingList.invoice_date)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">출발예정일</span>
                <span>{formatDate(packingList.departure_date)}</span>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  )
}
