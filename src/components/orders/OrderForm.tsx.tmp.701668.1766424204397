'use client'

import { useState, useMemo, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { useToast } from '@/hooks/use-toast'
import type { Product, Organization, Brand } from '@/types'

interface OrderFormProps {
  buyers: Organization[]
  products: Product[]
  brands: Brand[]
}

interface OrderItem {
  product: Product
  quantity: number
  cartons: number
}

export function OrderForm({ buyers, products, brands }: OrderFormProps) {
  const [buyerId, setBuyerId] = useState<string>('')
  const [orderItems, setOrderItems] = useState<OrderItem[]>([])
  const [productDialogOpen, setProductDialogOpen] = useState(false)
  const [productSearch, setProductSearch] = useState('')
  const [brandFilter, setBrandFilter] = useState<string>('all')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const { toast } = useToast()
  const router = useRouter()

  // 제품 필터링 (이미 추가된 제품 제외)
  const filteredProducts = useMemo(() => {
    const addedIds = new Set(orderItems.map(item => item.product.id))

    return products.filter(product => {
      if (addedIds.has(product.id)) return false

      const matchesSearch =
        product.product_code.toLowerCase().includes(productSearch.toLowerCase()) ||
        product.name_ko.toLowerCase().includes(productSearch.toLowerCase()) ||
        (product.barcode && product.barcode.includes(productSearch))

      const matchesBrand = brandFilter === 'all' || product.brand_id === brandFilter

      return matchesSearch && matchesBrand
    })
  }, [products, orderItems, productSearch, brandFilter])

  // 제품 추가
  const addProduct = useCallback((product: Product) => {
    setOrderItems(prev => [...prev, {
      product,
      quantity: product.pcs_per_carton, // 기본값: 1박스
      cartons: 1
    }])
  }, [])

  // 제품 제거
  const removeProduct = useCallback((productId: string) => {
    setOrderItems(prev => prev.filter(item => item.product.id !== productId))
  }, [])

  // 수량 변경 (카톤 단위)
  const updateQuantity = useCallback((productId: string, cartons: number) => {
    setOrderItems(prev => prev.map(item => {
      if (item.product.id !== productId) return item
      const newCartons = Math.max(1, cartons)
      return {
        ...item,
        cartons: newCartons,
        quantity: newCartons * item.product.pcs_per_carton
      }
    }))
  }, [])

  // 합계 계산
  const totals = useMemo(() => {
    return orderItems.reduce((acc, item) => {
      const subtotal = item.quantity * item.product.base_price_krw
      return {
        items: acc.items + 1,
        quantity: acc.quantity + item.quantity,
        cartons: acc.cartons + item.cartons,
        amount: acc.amount + subtotal
      }
    }, { items: 0, quantity: 0, cartons: 0, amount: 0 })
  }, [orderItems])

  // 발주서 제출
  const handleSubmit = async (asDraft: boolean = true) => {
    if (!buyerId) {
      toast({
        title: '바이어 선택 필요',
        description: '바이어를 선택해주세요.',
        variant: 'destructive'
      })
      return
    }

    if (orderItems.length === 0) {
      toast({
        title: '제품 추가 필요',
        description: '최소 1개 이상의 제품을 추가해주세요.',
        variant: 'destructive'
      })
      return
    }

    setIsSubmitting(true)
    try {
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          buyer_org_id: buyerId,
          status: asDraft ? 'DRAFT' : 'SUBMITTED',
          items: orderItems.map(item => ({
            product_id: item.product.id,
            requested_quantity: item.quantity,
            base_price: item.product.base_price_krw
          }))
        })
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || '발주서 생성 실패')
      }

      toast({
        title: '발주서 생성 완료',
        description: `발주번호: ${result.order_number}`,
      })

      router.push(`/orders/${result.id}`)
    } catch (error) {
      console.error('Order submit error:', error)
      toast({
        title: '발주서 생성 실패',
        description: error instanceof Error ? error.message : '알 수 없는 오류',
        variant: 'destructive'
      })
    } finally {
      setIsSubmitting(false)
    }
  }

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('ko-KR').format(price)
  }

  return (
    <div className="space-y-6">
      {/* 바이어 선택 */}
      <div className="flex items-center gap-4">
        <label className="font-medium min-w-[80px]">바이어</label>
        <Select value={buyerId} onValueChange={setBuyerId}>
          <SelectTrigger className="w-[300px]">
            <SelectValue placeholder="바이어를 선택하세요" />
          </SelectTrigger>
          <SelectContent>
            {buyers.map(buyer => (
              <SelectItem key={buyer.id} value={buyer.id}>
                {buyer.name_ko} ({buyer.region_code})
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* 제품 추가 버튼 */}
      <div className="flex justify-between items-center">
        <h3 className="font-medium">발주 품목 ({orderItems.length}개)</h3>
        <Dialog open={productDialogOpen} onOpenChange={setProductDialogOpen}>
          <DialogTrigger asChild>
            <Button>+ 제품 추가</Button>
          </DialogTrigger>
          <DialogContent className="max-w-4xl max-h-[80vh]">
            <DialogHeader>
              <DialogTitle>제품 선택</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              {/* 검색/필터 */}
              <div className="flex gap-4">
                <Input
                  placeholder="품목코드, 품목명, 바코드 검색..."
                  value={productSearch}
                  onChange={(e) => setProductSearch(e.target.value)}
                  className="flex-1"
                />
                <Select value={brandFilter} onValueChange={setBrandFilter}>
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="브랜드" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">전체 브랜드</SelectItem>
                    {brands.map(brand => (
                      <SelectItem key={brand.id} value={brand.id}>
                        {brand.name_ko}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* 제품 목록 */}
              <div className="border rounded-lg max-h-[400px] overflow-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>품목코드</TableHead>
                      <TableHead>브랜드</TableHead>
                      <TableHead>품목명</TableHead>
                      <TableHead className="text-center">입수량</TableHead>
                      <TableHead className="text-right">단가</TableHead>
                      <TableHead className="text-center">추가</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredProducts.slice(0, 50).map(product => (
                      <TableRow key={product.id}>
                        <TableCell className="font-mono">{product.product_code}</TableCell>
                        <TableCell>{product.brand?.name_ko || '-'}</TableCell>
                        <TableCell className="max-w-[200px] truncate">{product.name_ko}</TableCell>
                        <TableCell className="text-center">{product.pcs_per_carton}</TableCell>
                        <TableCell className="text-right">{formatPrice(product.base_price_krw)}</TableCell>
                        <TableCell className="text-center">
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              addProduct(product)
                              toast({ title: `${product.name_ko} 추가됨` })
                            }}
                          >
                            추가
                          </Button>
                        </TableCell>
                      </TableRow>
                    ))}
                    {filteredProducts.length === 0 && (
                      <TableRow>
                        <TableCell colSpan={6} className="text-center py-8 text-muted-foreground">
                          검색 결과가 없습니다.
                        </TableCell>
                      </TableRow>
                    )}
                  </TableBody>
                </Table>
              </div>
              <div className="text-sm text-muted-foreground">
                {filteredProducts.length}개 제품 (최대 50개 표시)
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* 발주 품목 테이블 */}
      {orderItems.length > 0 ? (
        <div className="border rounded-lg">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>품목코드</TableHead>
                <TableHead>브랜드</TableHead>
                <TableHead>품목명</TableHead>
                <TableHead className="text-center">입수량</TableHead>
                <TableHead className="text-center">박스수</TableHead>
                <TableHead className="text-center">수량</TableHead>
                <TableHead className="text-right">단가</TableHead>
                <TableHead className="text-right">금액</TableHead>
                <TableHead className="text-center">삭제</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {orderItems.map(item => {
                const subtotal = item.quantity * item.product.base_price_krw
                return (
                  <TableRow key={item.product.id}>
                    <TableCell className="font-mono">{item.product.product_code}</TableCell>
                    <TableCell>{item.product.brand?.name_ko || '-'}</TableCell>
                    <TableCell className="max-w-[200px] truncate">{item.product.name_ko}</TableCell>
                    <TableCell className="text-center">{item.product.pcs_per_carton}</TableCell>
                    <TableCell className="text-center">
                      <Input
                        type="number"
                        min="1"
                        value={item.cartons}
                        onChange={(e) => updateQuantity(item.product.id, parseInt(e.target.value) || 1)}
                        className="w-20 text-center"
                      />
                    </TableCell>
                    <TableCell className="text-center font-medium">
                      {item.quantity.toLocaleString()}
                    </TableCell>
                    <TableCell className="text-right">{formatPrice(item.product.base_price_krw)}</TableCell>
                    <TableCell className="text-right font-medium">{formatPrice(subtotal)}</TableCell>
                    <TableCell className="text-center">
                      <Button
                        size="sm"
                        variant="ghost"
                        className="text-red-600 hover:text-red-700"
                        onClick={() => removeProduct(item.product.id)}
                      >
                        삭제
                      </Button>
                    </TableCell>
                  </TableRow>
                )
              })}
            </TableBody>
          </Table>
        </div>
      ) : (
        <div className="border rounded-lg p-8 text-center text-muted-foreground">
          제품을 추가해주세요.
        </div>
      )}

      {/* 합계 */}
      {orderItems.length > 0 && (
        <div className="flex justify-end">
          <div className="bg-muted p-4 rounded-lg space-y-2 min-w-[300px]">
            <div className="flex justify-between">
              <span>품목수</span>
              <span className="font-medium">{totals.items}개</span>
            </div>
            <div className="flex justify-between">
              <span>총 수량</span>
              <span className="font-medium">{totals.quantity.toLocaleString()}개</span>
            </div>
            <div className="flex justify-between">
              <span>총 박스</span>
              <span className="font-medium">{totals.cartons.toLocaleString()} CTN</span>
            </div>
            <div className="flex justify-between border-t pt-2">
              <span className="font-medium">총 공급가</span>
              <span className="font-bold text-lg">₩{formatPrice(totals.amount)}</span>
            </div>
          </div>
        </div>
      )}

      {/* 제출 버튼 */}
      <div className="flex justify-end gap-4 pt-4 border-t">
        <Button
          variant="outline"
          onClick={() => router.push('/orders')}
          disabled={isSubmitting}
        >
          취소
        </Button>
        <Button
          variant="secondary"
          onClick={() => handleSubmit(true)}
          disabled={isSubmitting || orderItems.length === 0}
        >
          {isSubmitting ? '저장 중...' : '임시 저장'}
        </Button>
        <Button
          onClick={() => handleSubmit(false)}
          disabled={isSubmitting || orderItems.length === 0 || !buyerId}
        >
          {isSubmitting ? '제출 중...' : '발주서 제출'}
        </Button>
      </div>
    </div>
  )
}
