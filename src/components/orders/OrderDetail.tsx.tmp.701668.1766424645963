'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import type { Order, OrderItem, Product, Brand } from '@/types'

interface OrderItemWithProduct extends OrderItem {
  product: Product & { brand?: Brand }
}

interface OrderDetailProps {
  order: Order
  items: OrderItemWithProduct[]
}

export function OrderDetail({ order, items }: OrderDetailProps) {
  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('ko-KR').format(price)
  }

  return (
    <div className="border rounded-lg overflow-hidden">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-[60px]">No</TableHead>
            <TableHead>품목코드</TableHead>
            <TableHead>브랜드</TableHead>
            <TableHead>품목명</TableHead>
            <TableHead className="text-center">입수량</TableHead>
            <TableHead className="text-center">요청수량</TableHead>
            <TableHead className="text-center">확정수량</TableHead>
            <TableHead className="text-right">단가</TableHead>
            <TableHead className="text-right">금액</TableHead>
            <TableHead className="text-center">유통기한</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {items.length === 0 ? (
            <TableRow>
              <TableCell colSpan={10} className="text-center py-8 text-muted-foreground">
                발주 품목이 없습니다.
              </TableCell>
            </TableRow>
          ) : (
            items.map((item, index) => {
              const quantity = item.confirmed_quantity ?? item.requested_quantity
              const subtotal = quantity * item.base_price
              const isAdjusted = item.confirmed_quantity != null &&
                                 item.confirmed_quantity !== item.requested_quantity

              return (
                <TableRow key={item.id}>
                  <TableCell className="text-center">{index + 1}</TableCell>
                  <TableCell className="font-mono">{item.product?.product_code}</TableCell>
                  <TableCell>{item.product?.brand?.name_ko || '-'}</TableCell>
                  <TableCell className="max-w-[200px]">
                    <div className="truncate">{item.product?.name_ko}</div>
                    {item.product?.name_en && (
                      <div className="text-xs text-muted-foreground truncate">
                        {item.product.name_en}
                      </div>
                    )}
                  </TableCell>
                  <TableCell className="text-center">
                    {item.product?.pcs_per_carton}
                  </TableCell>
                  <TableCell className="text-center">
                    {item.requested_quantity.toLocaleString()}
                  </TableCell>
                  <TableCell className="text-center">
                    {item.confirmed_quantity != null ? (
                      <span className={isAdjusted ? 'text-orange-600 font-medium' : ''}>
                        {item.confirmed_quantity.toLocaleString()}
                        {isAdjusted && (
                          <span className="text-xs ml-1">
                            ({item.confirmed_quantity > item.requested_quantity ? '+' : ''}
                            {item.confirmed_quantity - item.requested_quantity})
                          </span>
                        )}
                      </span>
                    ) : (
                      <span className="text-muted-foreground">-</span>
                    )}
                  </TableCell>
                  <TableCell className="text-right">
                    {formatPrice(item.base_price)}
                  </TableCell>
                  <TableCell className="text-right font-medium">
                    {formatPrice(subtotal)}
                  </TableCell>
                  <TableCell className="text-center">
                    <ExpiryBadge status={item.expiry_status} note={item.expiry_note} />
                  </TableCell>
                </TableRow>
              )
            })
          )}
        </TableBody>
      </Table>
    </div>
  )
}

function ExpiryBadge({ status, note }: { status: string; note?: string | null }) {
  const statusConfig: Record<string, { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline' }> = {
    PENDING: { label: '확인중', variant: 'secondary' },
    OK: { label: 'OK', variant: 'default' },
    WARNING: { label: '주의', variant: 'outline' },
    REJECTED: { label: '불가', variant: 'destructive' },
  }

  const config = statusConfig[status] || { label: status, variant: 'secondary' }

  return (
    <Badge variant={config.variant} title={note || undefined}>
      {config.label}
    </Badge>
  )
}
